# 処理フロー詳細

このドキュメントでは、ta-backend-mlプロジェクトにおける処理のワークフローを詳細に説明します。

## 現在の主要機能

現在、ta-backend-mlプロジェクトでは以下の主要な機能を提供しています：

1. Google Vertex AI Agent Builder連携
2. URLスクレイピング
3. Webクローリング
4. Geminiによるドキュメントグラウンディング
5. ブラウザレンダリングとPDF変換
6. PDFファイル処理
7. ベクトルデータベース検索

## 各機能の処理フロー

### 1. Google Vertex AI Agent Builder連携

Google Vertex AI Agent Builderを使用した検索・質問応答は以下のステップで処理されます：

```
検索/質問リクエスト
    ↓
Google Cloud認証トークン取得
    ↓
Agent Builder APIへのリクエスト
    ↓
検索結果の受信と整形
    ↓
結果をクライアントに返却
```

### 2. URLスクレイピング

特定のURLに対するスクレイピングは以下のステップで処理されます：

```
URLリクエスト
    ↓
リクエストの認証検証
    ↓
URLコンテンツの取得
    ↓
HTMLからのマークダウン変換
    ↓
メタデータ（タイトル、説明、言語など）の抽出
    ↓
結果をクライアントに返却
```

### 3. Webクローリング

Webサイトのクローリングは以下のステップで処理されます：

```
クロールリクエスト
    ↓
リクエストの認証検証
    ↓
URLの正規化と検証
    ↓
クロールジョブのキューへの追加
    ↓
ステータス情報をクライアントに返却
```

クロールジョブは非同期で以下のステップを実行します：

```
キューからジョブ取得
    ↓
Webページの取得
    ↓
コンテンツの抽出と保存
    ↓
リンクの抽出と追加処理
    ↓
データベースへの保存
```

### 4. Geminiによるドキュメントグラウンディング

Google Geminiを使用したドキュメントグラウンディングは以下のステップで処理されます：

```
画像/文書リクエスト
    ↓
プロンプトとデータの検証
    ↓
Vertex AI Geminiモデルの初期化
    ↓
マルチモーダル処理の実行
    ↓
結果をクライアントに返却
```

### 5. ブラウザレンダリングとPDF変換

Webページをレンダリングしてへ変換する処理は以下のステップで行われます：

```
URL変換リクエスト
    ↓
ヘッドレスブラウザの起動
    ↓
ページのレンダリングとスクリーンショット
    ↓
PDFへの変換
    ↓
結果（ファイルパス）をクライアントに返却
```

### 6. PDFファイル処理

PDFファイルの処理は以下のステップで行われます：

```
PDF処理リクエスト
    ↓
ファイルパスの検証
    ↓
PDFを画像に変換
    ↓
各ページの画像をBase64エンコード
    ↓
Google Geminiによる個別ページの分析
    ↓
結果の集約
    ↓
処理結果をクライアントに返却
```

### 7. ベクトルデータベース検索

ベクトルデータベースを使用した情報検索は以下のステップで処理されます：

```
検索リクエスト
    ↓
リクエストの認証検証
    ↓
検索クエリのベクトル化
    ↓
ベクトルDBでの類似度検索
    ↓
検索結果の整形
    ↓
結果をクライアントに返却
```

## エラー処理

すべての処理フローにおいて、以下のエラー処理が実装されています：

1. 入力バリデーション - リクエストパラメータの検証
2. 認証エラー - 認証トークンが無効または欠落している場合
3. 外部APIエラー - 外部サービス（Google Cloud、Webサイトなど）からのエラーレスポンス
4. タイムアウト処理 - 長時間実行される処理のタイムアウト管理
5. エラーログ記録 - すべてのエラーは適切にログに記録

## パフォーマンス最適化

システム全体のパフォーマンスは以下の方法で最適化されています：

1. 非同期処理 - 時間のかかる処理は非同期で実行
2. キャッシュ - 頻繁に使用されるデータのキャッシュ
3. バッチ処理 - 大量のデータを効率的に処理するためのバッチ処理
4. リソース管理 - CPUとメモリの使用量の監視と最適化

## API実行方法

各機能はAPIエンドポイントを通じて実行できます。詳細なAPI仕様は[API.md](./API.md)を参照してください。

## データフロー

### Web情報収集と分析フロー

Webコンテンツの収集と分析のフローは以下のようになっています：

```
URLスクレイピングAPI
    ↓
コンテンツ抽出
    ↓
Webクローラーへの追加（オプション）
    ↓
ベクトルDBへの保存
    ↓
検索・分析のためのインデックス作成
```

### マルチモーダル文書処理フロー

PDFなどの文書の処理フローは以下のようになっています：

```
ファイルアップロードAPI
    ↓
PDFからの画像変換
    ↓
Geminiによる各ページの分析
    ↓
結果の統合と要約
    ↓
情報の構造化（オプション）
```

## インフラストラクチャ

ta-backend-mlプロジェクトは以下のインフラストラクチャ上で実行されています：

1. Dockerコンテナ - アプリケーションの実行環境
2. Google Cloud - 認証、Vertex AI、Agent Builderなどのサービス
3. ローカルストレージ - 一時ファイルと処理結果の保存
4. データベース - クロールデータやユーザーデータの保存

## リソース要件

このプロジェクトを実行するための推奨リソース要件：

- CPU: 4コア以上
- メモリ: 8GB以上
- ディスク: 20GB以上の空き容量
- ネットワーク: 安定したインターネット接続

## 認証と権限

外部サービスへのアクセスには以下の認証情報が必要です：

1. Google Cloud認証情報 - Vertex AIとAgent Builderへのアクセス
2. API Token - 内部APIアクセスの認証

詳細なセットアップ手順は[SETUP.md](./SETUP.md)を参照してください。 
